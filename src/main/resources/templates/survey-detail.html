<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${survey.title}"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1 th:text="${survey.title}">설문조사 제목</h1>
    <p class="lead" th:text="${survey.description}">설문조사 설명</p>

    <hr>

    <form id="surveyForm">
        <input type="hidden" name="surveyId" th:value="${survey.surveyId}">
        <div th:each="question, qStat : ${survey.questions}" class="mb-4">
            <h5 th:text="${(qStat.index + 1) + '. ' + question.text}">질문 내용</h5>
            <input type="hidden" th:name="|answers[${qStat.index}].questionId|" th:value="${question.questionId}">

            <div th:if="${question.type.name() == 'SINGLE_CHOICE'}">
                <div th:each="choice : ${question.choices}" class="form-check">
                    <input class="form-check-input" type="radio"
                           th:name="|answers[${qStat.index}].selectedChoiceIds|"
                           th:id="|choice-${question.id}-${choice.id}|"
                           th:value="${choice.id}">
                    <label class="form-check-label" th:for="|choice-${question.id}-${choice.id}|" th:text="${choice.text}">
                        선택지
                    </label>
                </div>
            </div>

            <div th:if="${question.type.name() == 'MULTIPLE_CHOICE'}">
                <div th:each="choice : ${question.choices}" class="form-check">
                    <input class="form-check-input" type="checkbox"
                           th:name="|answers[${qStat.index}].selectedChoiceIds|"
                           th:id="|choice-${question.id}-${choice.id}|"
                           th:value="${choice.id}">
                    <label class="form-check-label" th:for="|choice-${question.id}-${choice.id}|" th:text="${choice.text}">
                        선택지
                    </label>
                </div>
            </div>

            <div th:if="${question.type.name() == 'TEXT'}">
                <textarea class="form-control" th:name="|answers[${qStat.index}].responseText|" rows="3" placeholder="답변을 입력하세요"></textarea>
            </div>
        </div>

        <button type="submit" class="btn btn-primary">답변 제출</button>
    </form>

    <div id="message" class="mt-3"></div>
</div>

<script>
    document.getElementById('surveyForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const form = event.target;
        const surveyId = form.elements.surveyId.value;
        const answers = [];

        form.querySelectorAll('.mb-4').forEach((questionDiv, qIndex) => {
            const questionId = questionDiv.querySelector('input[type="hidden"]').value;
            let selectedChoiceIds = [];
            let responseText = '';

            const radioInputs = questionDiv.querySelectorAll('input[type="radio"]:checked');
            if (radioInputs.length > 0) {
                selectedChoiceIds.push(radioInputs[0].value);
            }

            const checkboxInputs = questionDiv.querySelectorAll('input[type="checkbox"]:checked');
            checkboxInputs.forEach(checkbox => {
                selectedChoiceIds.push(checkbox.value);
            });

            const textareaInput = questionDiv.querySelector('textarea');
            if (textareaInput) {
                responseText = textareaInput.value;
            }

            answers.push({
                questionId: parseInt(questionId),
                selectedChoiceIds: selectedChoiceIds.map(id => parseInt(id)),
                responseText: responseText
            });
        });

        const messageDiv = document.getElementById('message');
        const jwtToken = localStorage.getItem('jwtToken');

        if (!jwtToken) {
            messageDiv.innerHTML = '<div class="alert alert-danger">답변을 제출하려면 로그인해야 합니다.</div>';
            return;
        }

        fetch(`/api/surveys/${surveyId}/responses`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + jwtToken
            },
            body: JSON.stringify({ answers: answers }),
        })
        .then(response => {
            if (response.ok) {
                return response.text(); // Assuming success returns text or no content
            }
            return response.json().then(err => { throw new Error(err.message || '답변 제출에 실패했습니다.') });
        })
        .then(text => {
            messageDiv.innerHTML = '<div class="alert alert-success">답변이 성공적으로 제출되었습니다!</div>';
            // Optionally redirect or show results
            setTimeout(() => {
                window.location.href = `/surveys/${surveyId}/results`; // Redirect to results page
            }, 2000);
        })
        .catch(error => {
            messageDiv.innerHTML = '<div class="alert alert-danger">' + error.message + '</div>';
        });
    });
</script>
</body>
</html>
