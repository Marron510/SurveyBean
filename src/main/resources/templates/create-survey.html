<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>새 설문조사 만들기</title>
    <link rel="stylesheet" th:href="@{/css/create-survey.css}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>

<header class="header">
    <a th:href="@{/}" class="logo">SurveyBean</a>
    <nav class="nav">
        <a th:href="@{/logout}">로그아웃</a>
    </nav>
</header>

<div class="survey-creator-container">
    <h1>새 설문조사 만들기</h1>

    <form id="createSurveyForm">
        <div class="form-group">
            <label for="surveyTitle">설문조사 제목</label>
            <input type="text" class="form-control" id="surveyTitle" placeholder="설문조사의 주제를 입력하세요" required>
        </div>
        <div class="form-group">
            <label for="surveyDescription">설문조사 설명</label>
            <textarea class="form-control" id="surveyDescription" placeholder="설문조사에 대한 간단한 설명을 추가하세요" rows="3" required></textarea>
        </div>

        <hr style="margin: 30px 0;">

        <h3>질문 목록</h3>
        <div id="questionsContainer">
            <!-- Questions will be added here dynamically -->
        </div>

        <div class="action-buttons">
            <button type="button" class="btn btn-info" id="addQuestionBtn">질문 추가</button>
        </div>

        <div class="action-buttons" style="margin-top: 40px;">
            <button type="submit" class="btn btn-primary">설문조사 생성 완료</button>
        </div>
    </form>

    <div id="message" style="margin-top: 20px; text-align: center;"></div>
</div>

<script>
    // The existing JavaScript from the old file will be pasted here.
    // It is functionally correct.
    let questionIndex = 0;

    document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
    document.getElementById('createSurveyForm').addEventListener('submit', createSurvey);

    function addQuestion() {
        const questionsContainer = document.getElementById('questionsContainer');
        const questionDiv = document.createElement('div');
        questionDiv.classList.add('question-card');
        questionDiv.innerHTML = `
            <div class="question-header">
                <h5>질문 ${questionIndex + 1}</h5>
                <button type="button" class="btn btn-sm btn-danger remove-question-btn">삭제</button>
            </div>
            <div class="form-group">
                <label>질문 내용</label>
                <input type="text" class="form-control question-text" required>
            </div>
            <div class="form-group">
                <label>질문 유형</label>
                <select class="form-control question-type">
                    <option value="SINGLE_CHOICE">단일 선택</option>
                    <option value="MULTIPLE_CHOICE">다중 선택</option>
                    <option value="TEXT">주관식</option>
                </select>
            </div>
            <div class="choices-container">
                <!-- Choices will be added here dynamically -->
            </div>
            <button type="button" class="btn btn-sm btn-success add-choice-btn" style="display: none; margin-top: 10px;">선택지 추가</button>
        `;
        questionsContainer.appendChild(questionDiv);

        const questionTypeSelect = questionDiv.querySelector('.question-type');
        const choicesContainer = questionDiv.querySelector('.choices-container');
        const addChoiceBtn = questionDiv.querySelector('.add-choice-btn');
        const removeQuestionBtn = questionDiv.querySelector('.remove-question-btn');

        questionTypeSelect.addEventListener('change', function() {
            if (this.value === 'SINGLE_CHOICE' || this.value === 'MULTIPLE_CHOICE') {
                addChoiceBtn.style.display = 'inline-block';
                if (choicesContainer.children.length === 0) {
                    addChoice(choicesContainer);
                }
            } else {
                addChoiceBtn.style.display = 'none';
                choicesContainer.innerHTML = '';
            }
        });

        addChoiceBtn.addEventListener('click', function() {
            addChoice(choicesContainer);
        });

        removeQuestionBtn.addEventListener('click', function() {
            questionDiv.remove();
        });

        questionTypeSelect.dispatchEvent(new Event('change'));
        questionIndex++;
    }

    function addChoice(choicesContainer) {
        const choiceDiv = document.createElement('div');
        choiceDiv.classList.add('input-group');
        choiceDiv.innerHTML = `
            <input type="text" class="form-control choice-text" placeholder="선택지 내용" required>
            <button type="button" class="btn btn-sm btn-outline-danger remove-choice-btn">삭제</button>
        `;
        choicesContainer.appendChild(choiceDiv);

        choiceDiv.querySelector('.remove-choice-btn').addEventListener('click', function() {
            choiceDiv.remove();
        });
    }

    async function createSurvey(event) {
    event.preventDefault();

    const messageDiv = document.getElementById('message');
    const jwtToken = localStorage.getItem('jwt'); 

    if (!jwtToken) {
        messageDiv.innerHTML = '<div style="color: red;">로그인이 필요합니다.</div>';
        setTimeout(() => { window.location.href = '/login'; }, 2000);
        return;
    }

    const surveyTitle = document.getElementById('surveyTitle').value;
    const surveyDescription = document.getElementById('surveyDescription').value;
    const questions = [];

    document.querySelectorAll('#questionsContainer .question-card').forEach(questionDiv => {
        const questionText = questionDiv.querySelector('.question-text').value;
        const questionType = questionDiv.querySelector('.question-type').value;
        const choices = [];

        if (questionType === 'SINGLE_CHOICE' || questionType === 'MULTIPLE_CHOICE') {
            questionDiv.querySelectorAll('.choice-text').forEach(choiceInput => {
                choices.push({ text: choiceInput.value });
            });
        }

        questions.push({
            text: questionText,
            type: questionType,
            choices: choices
        });
    });

    const surveyData = {
        title: surveyTitle,
        description: surveyDescription,
        questions: questions
    };

    try {
        const response = await fetch('/api/surveys', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + jwtToken
            },
            body: JSON.stringify(surveyData),
        });

        if (response.ok) {
            messageDiv.innerHTML = '<div style="color: green;">설문조사가 성공적으로 생성되었습니다! 메인 페이지로 이동합니다...</div>';
            setTimeout(() => {
                window.location.href = '/';
            }, 2000);
        } else {
            const errorData = await response.json();
            throw new Error(errorData.message || '설문조사 생성에 실패했습니다.');
        }
    } catch (error) {
        messageDiv.innerHTML = '<div style="color: red;">' + error.message + '</div>';
        console.error('Submission Error:', error);
    }
}
</script>

</body>
</html>