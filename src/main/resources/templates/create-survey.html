<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>설문조사 생성</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <h1>새 설문조사 생성</h1>
    <hr>

    <form id="createSurveyForm">
        <div class="mb-3">
            <label for="surveyTitle" class="form-label">설문조사 제목</label>
            <input type="text" class="form-control" id="surveyTitle" required>
        </div>
        <div class="mb-3">
            <label for="surveyDescription" class="form-label">설문조사 설명</label>
            <textarea class="form-control" id="surveyDescription" rows="3" required></textarea>
        </div>

        <hr>
        <h3>질문 목록</h3>
        <div id="questionsContainer">
            <!-- Questions will be added here dynamically -->
        </div>
        <button type="button" class="btn btn-info mb-4" id="addQuestionBtn">질문 추가</button>

        <button type="submit" class="btn btn-primary">설문조사 생성</button>
    </form>

    <div id="message" class="mt-3"></div>
</div>

<script>
    let questionIndex = 0;

    document.getElementById('addQuestionBtn').addEventListener('click', addQuestion);
    document.getElementById('createSurveyForm').addEventListener('submit', createSurvey);

    function addQuestion() {
        const questionsContainer = document.getElementById('questionsContainer');
        const questionDiv = document.createElement('div');
        questionDiv.classList.add('card', 'mb-3', 'p-3');
        questionDiv.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>질문 ${questionIndex + 1}</h5>
                <button type="button" class="btn btn-sm btn-danger remove-question-btn">삭제</button>
            </div>
            <div class="mb-3">
                <label class="form-label">질문 내용</label>
                <input type="text" class="form-control question-text" required>
            </div>
            <div class="mb-3">
                <label class="form-label">질문 유형</label>
                <select class="form-select question-type">
                    <option value="SINGLE_CHOICE">단일 선택</option>
                    <option value="MULTIPLE_CHOICE">다중 선택</option>
                    <option value="TEXT">주관식</option>
                </select>
            </div>
            <div class="choices-container">
                <!-- Choices will be added here dynamically -->
            </div>
            <button type="button" class="btn btn-sm btn-success add-choice-btn mt-2" style="display: none;">선택지 추가</button>
        `;
        questionsContainer.appendChild(questionDiv);

        const questionTypeSelect = questionDiv.querySelector('.question-type');
        const choicesContainer = questionDiv.querySelector('.choices-container');
        const addChoiceBtn = questionDiv.querySelector('.add-choice-btn');
        const removeQuestionBtn = questionDiv.querySelector('.remove-question-btn');

        questionTypeSelect.addEventListener('change', function() {
            if (this.value === 'SINGLE_CHOICE' || this.value === 'MULTIPLE_CHOICE') {
                addChoiceBtn.style.display = 'block';
                if (choicesContainer.children.length === 0) { // Add a default choice if none exist
                    addChoice(choicesContainer);
                }
            } else {
                addChoiceBtn.style.display = 'none';
                choicesContainer.innerHTML = ''; // Clear choices for text type
            }
        });

        addChoiceBtn.addEventListener('click', function() {
            addChoice(choicesContainer);
        });

        removeQuestionBtn.addEventListener('click', function() {
            questionDiv.remove();
        });

        // Trigger change to set initial state for choices
        questionTypeSelect.dispatchEvent(new Event('change'));

        questionIndex++;
    }

    function addChoice(choicesContainer) {
        const choiceDiv = document.createElement('div');
        choiceDiv.classList.add('input-group', 'mb-2');
        choiceDiv.innerHTML = `
            <input type="text" class="form-control choice-text" placeholder="선택지 내용" required>
            <button type="button" class="btn btn-outline-danger remove-choice-btn">삭제</button>
        `;
        choicesContainer.appendChild(choiceDiv);

        choiceDiv.querySelector('.remove-choice-btn').addEventListener('click', function() {
            choiceDiv.remove();
        });
    }

    async function createSurvey(event) {
        event.preventDefault();

        const form = event.target;
        const messageDiv = document.getElementById('message');
        const jwtToken = localStorage.getItem('jwtToken');

        if (!jwtToken) {
            messageDiv.innerHTML = '<div class="alert alert-danger">설문조사를 생성하려면 로그인해야 합니다.</div>';
            return;
        }

        const surveyTitle = document.getElementById('surveyTitle').value;
        const surveyDescription = document.getElementById('surveyDescription').value;
        const questions = [];

        document.querySelectorAll('#questionsContainer > .card').forEach(questionDiv => {
            const questionText = questionDiv.querySelector('.question-text').value;
            const questionType = questionDiv.querySelector('.question-type').value;
            const choices = [];

            if (questionType === 'SINGLE_CHOICE' || questionType === 'MULTIPLE_CHOICE') {
                questionDiv.querySelectorAll('.choice-text').forEach(choiceInput => {
                    choices.push({ text: choiceInput.value });
                });
            }

            questions.push({
                text: questionText,
                type: questionType,
                choices: choices
            });
        });

        const surveyData = {
            title: surveyTitle,
            description: surveyDescription,
            questions: questions
        };

        try {
            const response = await fetch('/api/surveys', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + jwtToken
                },
                body: JSON.stringify(surveyData),
            });

            if (response.ok) {
                messageDiv.innerHTML = '<div class="alert alert-success">설문조사가 성공적으로 생성되었습니다! 메인 페이지로 이동합니다...</div>';
                setTimeout(() => {
                    window.location.href = '/';
                }, 2000);
            } else {
                const errorData = await response.json();
                throw new Error(errorData.message || '설문조사 생성에 실패했습니다.');
            }
        } catch (error) {
            messageDiv.innerHTML = '<div class="alert alert-danger">' + error.message + '</div>';
        }
    }
</script>
</body>
</html>
